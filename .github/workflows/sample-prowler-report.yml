name: Sample Prowler-style Report

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  generate-report:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate sample Prowler-style report
        run: |
          REPORT_ROOT="artifacts"
          REPORT_DIR="prowler-report-$(date +%Y%m%d-%H%M%S)"
          FULL_PATH="$REPORT_ROOT/$REPORT_DIR"

          mkdir -p "$FULL_PATH/html"

          # Text summary
          printf '%s\n' \
            'Prowler sample summary' \
            '----------------------' \
            'This is a dummy report generated for testing purposes only.' \
            'Use it to test your email/notification pipeline and artifact handling.' \
            > "$FULL_PATH/summary.txt"

          # CSV with example findings
          printf '%s\n' \
            'check_id,severity,resource,status,region' \
            'iam_001,High,User:alice,FAIL,eu-west-1' \
            's3_010,Medium,Bucket:my-logs,FAIL,eu-west-1' \
            'ec2_005,Low,Instance:i-0123456789abcdef0,PASS,eu-west-1' \
            > "$FULL_PATH/findings.csv"

          # JSON metadata
          printf '%s\n' \
            '{' \
            '  "tool": "prowler",' \
            '  "type": "sample",' \
            "  \"generated_at\": \"$(date -u +\"%Y-%m-%dT%H:%M:%SZ\")\"," \
            '  "account_id": "123456789012",' \
            '  "region": "eu-west-1"' \
            '}' \
            > "$FULL_PATH/metadata.json"

          # YAML-style configuration snapshot
          printf '%s\n' \
            'account:' \
            '  id: "123456789012"' \
            '  alias: "sample-account"' \
            'scan:' \
            '  regions:' \
            '    - eu-west-1' \
            '  services:' \
            '    - iam' \
            '    - s3' \
            '    - ec2' \
            > "$FULL_PATH/config.yaml"

          # Simple HTML report
          printf '%s\n' \
            '<!DOCTYPE html>' \
            '<html lang="en">' \
            '  <head>' \
            '    <meta charset="UTF-8" />' \
            '    <title>Prowler Sample Report</title>' \
            '    <style>' \
            '      body { font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; margin: 2rem; }' \
            '      h1 { color: #0b7285; }' \
            '      table { border-collapse: collapse; width: 100%; margin-top: 1rem; }' \
            '      th, td { border: 1px solid #dee2e6; padding: 0.5rem 0.75rem; font-size: 0.9rem; }' \
            '      th { background: #f1f3f5; text-align: left; }' \
            '      .severity-High { color: #c92a2a; font-weight: 600; }' \
            '      .severity-Medium { color: #d9480f; font-weight: 600; }' \
            '      .severity-Low { color: #2b8a3e; font-weight: 600; }' \
            '    </style>' \
            '  </head>' \
            '  <body>' \
            '    <h1>Prowler Sample Report</h1>' \
            '    <p>This is a sample HTML report generated by GitHub Actions for testing email and artifact workflows.</p>' \
            '    <table>' \
            '      <thead>' \
            '        <tr>' \
            '          <th>Check ID</th>' \
            '          <th>Severity</th>' \
            '          <th>Resource</th>' \
            '          <th>Status</th>' \
            '          <th>Region</th>' \
            '        </tr>' \
            '      </thead>' \
            '      <tbody>' \
            '        <tr>' \
            '          <td>iam_001</td>' \
            '          <td class="severity-High">High</td>' \
            '          <td>User:alice</td>' \
            '          <td>FAIL</td>' \
            '          <td>eu-west-1</td>' \
            '        </tr>' \
            '        <tr>' \
            '          <td>s3_010</td>' \
            '          <td class="severity-Medium">Medium</td>' \
            '          <td>Bucket:my-logs</td>' \
            '          <td>FAIL</td>' \
            '          <td>eu-west-1</td>' \
            '        </tr>' \
            '        <tr>' \
            '          <td>ec2_005</td>' \
            '          <td class="severity-Low">Low</td>' \
            '          <td>Instance:i-0123456789abcdef0</td>' \
            '          <td>PASS</td>' \
            '          <td>eu-west-1</td>' \
            '        </tr>' \
            '      </tbody>' \
            '    </table>' \
            '  </body>' \
            '</html>' \
            > "$FULL_PATH/html/index.html"

      - name: Upload sample report artifact
        uses: actions/upload-artifact@v4
        with:
          name: prowler-sample-report
          path: artifacts/
          if-no-files-found: error

  email-report:
    needs: generate-report
    runs-on: ubuntu-latest

    steps:
      - name: Download generated report artifact
        uses: actions/download-artifact@v4
        with:
          name: prowler-sample-report
          path: report

      - name: Zip report folder
        run: |
          cd report
          zip -r ../prowler-sample-report.zip .

      - name: Send report via email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "Prowler sample report from GitHub Actions"
          from: ${{ secrets.EMAIL_FROM }}
          to: ${{ secrets.EMAIL_TO }}
          body: |
            Hi,

            Attached is the latest Prowler-style sample report generated by GitHub Actions.

            This email was sent automatically for testing purposes.
          attachments: prowler-sample-report.zip

